name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  verify-configs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install yamllint
      run: |
        sudo apt-get update
        sudo apt-get install -y yamllint

    - name: Check YAML syntax
      run: |
        yamllint -d '{extends: default, rules: {line-length: disable}}'           prometheus.yaml           alerts.yml           docker-compose.test.yml           grafana-datasource.yaml           config/prometheus.yml

    - name: Validate Docker Compose
      run: docker-compose -f docker-compose.test.yml config

  docker:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and test exporters
      run: |
        cd exporters
        docker build -t ha-ai-exporters .
        docker network create metrics_net
        docker run --rm --network metrics_net -e METRICS_PORT=9090 ha-ai-exporters openwakeword_metrics.py &
        docker run --rm --network metrics_net -e METRICS_PORT=9091 ha-ai-exporters piper_metrics.py &
        docker run --rm --network metrics_net -e METRICS_PORT=9092 ha-ai-exporters whisper_metrics.py &
        sleep 10
        docker ps

  test-exporters:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: exporters
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: Run tests
      run: |
        chmod +x test_collectors.sh
        ./test_collectors.sh
